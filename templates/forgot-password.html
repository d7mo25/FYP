<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIU Smart Resume Analyzer - Reset Password</title>
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  
  <style>
   .reset-container {
      max-width: 400px;
      margin: 30px auto;
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, .2);
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      min-height: 400px;
    }
    
    .reset-container h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #fff;
      font-size: 28px;
    }
    
    .reset-info {
      text-align: center;
      margin-bottom: 25px;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.6;
      font-size: 14px;
    }
    
    .message-box {
      padding: 12px 16px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
      border-left: 4px solid;
    }
    
    .success {
      background-color: rgba(212, 237, 218, 0.9);
      color: #155724;
      border-left-color: #28a745;
    }
    
    .error {
      background-color: rgba(248, 215, 218, 0.9);
      color: #721c24;
      border-left-color: #dc3545;
    }
    
    .warning {
      background-color: rgba(255, 243, 205, 0.9);
      color: #856404;
      border-left-color: #ffc107;
    }
    
    .info {
      background-color: rgba(209, 236, 241, 0.9);
      color: #0c5460;
      border-left-color: #17a2b8;
    }
    
    .hidden {
      display: none;
    }
    
    .btn {
      width: 100%;
      height: 45px;
      background: linear-gradient(45deg, #3e54ac, #4361ee);
      border: none;
      outline: none;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      font-size: 16px;
      color: #fff;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-bottom: 15px;
      position: relative;
      overflow: hidden;
    }
    
    .btn:hover:not(:disabled) {
      background: linear-gradient(45deg, #2a3990, #3e54ac);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .btn-secondary {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      height: 40px;
      font-size: 14px;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }
    
    .input-box {
      position: relative;
      width: 100%;
      height: 50px;
      margin: 25px 0;
    }
    
    .input-box input {
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      outline: none;
      font-size: 16px;
      color: #fff;
      padding: 0 45px 0 15px;
      transition: all 0.3s ease;
    }
    
    .input-box input:focus {
      border-color: #4361ee;
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 10px rgba(67, 97, 238, 0.3);
    }
    
    .input-box input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }
    
    .input-box i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: rgba(255, 255, 255, 0.6);
      transition: color 0.3s ease;
    }
    
    .input-box input:focus + i {
      color: #4361ee;
    }
    
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .back-link {
      text-align: center;
      margin-top: 25px;
    }

    .back-link a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s ease;
      font-size: 14px;
      border-bottom: 1px solid transparent;
    }

    .back-link a:hover {
      color: #4361ee;
      border-bottom-color: #4361ee;
    }

    .email-icon {
      font-size: 64px;
      color: #4361ee;
      margin-bottom: 20px;
      text-align: center;
      animation: emailPulse 2s ease-in-out infinite;
    }

    @keyframes emailPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .resend-section {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    .countdown {
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      margin-top: 10px;
      font-weight: 500;
    }

    .email-display {
      background: rgba(67, 97, 238, 0.2);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 25px;
      color: #fff;
      border: 1px solid rgba(67, 97, 238, 0.3);
      word-break: break-word;
      font-weight: 500;
    }

    .password-requirements {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .requirement {
      padding: 5px 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      font-size: 13px;
    }

    .requirement::before {
      content: "○";
      margin-right: 10px;
      font-weight: bold;
      font-size: 16px;
    }

    .requirement.valid {
      color: #28a745;
    }

    .requirement.valid::before {
      content: "✓";
      color: #28a745;
    }

    .requirement.invalid {
      color: #dc3545;
    }

    .requirement.invalid::before {
      content: "✗";
      color: #dc3545;
    }

    .requirement.neutral {
      color: rgba(255, 255, 255, 0.7);
    }

    /* Step Indicator */
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      padding: 0 20px;
    }

    .step {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      font-weight: bold;
      margin: 0 15px;
      position: relative;
      transition: all 0.3s ease;
    }

    .step.active {
      background: linear-gradient(45deg, #4361ee, #3e54ac);
      color: #fff;
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
    }

    .step.completed {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: #fff;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .step::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 100%;
      width: 30px;
      height: 3px;
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-50%);
      border-radius: 2px;
    }

    .step:last-child::after {
      display: none;
    }

    .step.completed::after {
      background: linear-gradient(90deg, #28a745, #20c997);
    }

    /* Success Animation */
    .success-icon {
      font-size: 80px;
      color: #28a745;
      text-align: center;
      margin-bottom: 25px;
      animation: successBounce 1s ease-in-out;
    }

    @keyframes successBounce {
      0% { transform: scale(0) rotate(0deg); }
      50% { transform: scale(1.2) rotate(180deg); }
      100% { transform: scale(1) rotate(360deg); }
    }

    /* Loading State */
    .loading-spinner {
      text-align: center;
      padding: 40px 20px;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #4361ee;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }



    /* Responsive Design */
    @media (max-width: 480px) {
      .reset-container {
        margin: 15px;
        padding: 20px;
      }
      
      .step-indicator {
        padding: 0 10px;
      }
      
      .step {
        margin: 0 8px;
      }
      
      .step::after {
        width: 16px;
      }
    }
  </style>
</head>
<body> 
  <header class="site-header">
    <img src="/static/logo.png" alt="logo" class="header-logo" >
    <h2>AIU Smart Resume Analyzer</h2>
  </header>

  <div class="reset-container">
    <!-- Step Indicator -->
    <div class="step-indicator" id="stepIndicator">
      <div class="step active" id="step1">1</div>
      <div class="step" id="step2">2</div>
      <div class="step" id="step3">3</div>
    </div>

    <!-- Step 1: Email Input -->
    <div id="emailStep">
      <h1>Reset Password</h1>
      <p class="reset-info">Enter your email address and we'll send you a link to reset your password</p>
      
      <div class="message-box error hidden" id="emailErrorMessage"></div>
      
      <div class="input-box">
        <input 
          type="email" 
          id="email" 
          placeholder="Enter your email address" 
          required 
          autocomplete="email"
        >
        <i class='bx bxs-envelope'></i>
      </div>
      
      <button type="button" class="btn" id="sendResetBtn">Send Reset Link</button>
      
      <div class="back-link">
        <a href="/">← Back to Login</a>
      </div>
    </div>

    <!-- Step 2: Email Sent Confirmation -->
    <div id="emailSentStep" class="hidden">
      <div class="email-icon">📧</div>
      <h1>Check Your Email</h1>
      <p class="reset-info">We've sent a password reset link to:</p>
      <div class="email-display" id="sentEmailDisplay"></div>
      <p class="reset-info">Click the link in your email to continue resetting your password.</p>
      
      <div class="message-box info">
        <strong>Didn't receive the email?</strong><br>
        Check your spam folder or try resending the link.
      </div>

      <div class="resend-section">
        <button type="button" class="btn btn-secondary" id="resendBtn">Resend Reset Link</button>
        <button type="button" class="btn btn-secondary" id="useNewEmailBtn">Use Different Email</button>
        <div class="countdown hidden" id="countdown"></div>
      </div>
      
      <div class="back-link">
        <a href="/">← Back to Login</a>
      </div>
    </div>

    <!-- Step 3: Password Reset Form (when coming from email link) -->
    <div id="passwordResetStep" class="hidden">
      <h1>Set New Password</h1>
      <p class="reset-info">Enter your new password below</p>
      
      <div class="email-display">
        Resetting password for: <strong id="resetEmailDisplay"></strong>
      </div>
      
      <div class="message-box error hidden" id="passwordErrorMessage"></div>
      
      <div class="input-box">
        <input 
          type="password" 
          id="newPassword" 
          placeholder="New Password" 
          required
        >
        <i class='bx bxs-lock-alt'></i>
      </div>
      
      <div class="input-box">
        <input 
          type="password" 
          id="confirmPassword" 
          placeholder="Confirm New Password" 
          required
        >
        <i class='bx bxs-lock-alt'></i>
      </div>
      
      <div class="password-requirements">
        <div class="requirement neutral" id="length">At least 8 characters long</div>
        <div class="requirement neutral" id="uppercase">Contains uppercase letter</div>
        <div class="requirement neutral" id="lowercase">Contains lowercase letter</div>
        <div class="requirement neutral" id="number">Contains at least one number</div>
        <div class="requirement neutral" id="special">Contains special character</div>
      </div>
      
      <button type="button" class="btn" id="resetPasswordBtn" disabled>Update Password</button>
      
      <div class="back-link">
        <a href="/">← Back to Login</a>
      </div>
    </div>

    <!-- Step 4: Success State -->
    <div id="successStep" class="hidden">
      <div class="success-icon">✅</div>
      <h1>Password Updated!</h1>
      <div class="message-box success">
        Your password has been successfully updated.
      </div>
      <p class="reset-info">You can now log in with your new password.</p>
      <a href="/" class="btn">Go to Login</a>
    </div>

    <!-- Loading State -->
    <div id="loadingStep" class="hidden">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p style="color: #fff;" id="loadingMessage">Processing...</p>
      </div>
    </div>

    <!-- Invalid Link State -->
    <div id="invalidLinkStep" class="hidden">
      <h1>Invalid Reset Link</h1>
      <div class="message-box error">
        This password reset link is invalid or has expired.
      </div>
      <p class="reset-info">Password reset links expire after 1 hour. Please request a new one.</p>
      <button type="button" class="btn" id="requestNewLinkBtn">Request New Reset Link</button>
      <div class="back-link">
        <a href="/">← Back to Login</a>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <p>&copy; DEVELOPED BY SCHOOL OF COMPUTING AND INFORMATICS</p>
  </footer>

  <script>
    console.log('🚀 Password Reset Page Loading...');

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBSBSkxJoya3yk4JA8wXp6BgF99GQJplrs",
      authDomain: "resume-analyzer-d58fd.firebaseapp.com",
      projectId: "resume-analyzer-d58fd",
      storageBucket: "resume-analyzer-d58fd.appspot.com",
      messagingSenderId: "1023421408848",
      appId: "1:1023421408848:web:efdae9407336d1d6b55355",
      measurementId: "G-S4KPNYZ8YB"
    };

    // Initialize Firebase
    let app, auth;
    try {
      if (firebase.apps.length === 0) {
        app = firebase.initializeApp(firebaseConfig);
        console.log('✅ Firebase initialized');
      } else {
        app = firebase.app();
        console.log('✅ Firebase already initialized');
      }
      auth = firebase.auth();
    } catch (error) {
      console.error('❌ Firebase initialization error:', error);
    }

    // Application state
    const appState = {
      isProcessing: false,
      currentEmail: '',
      actionCode: null,
      resendCountdown: 0,
      countdownInterval: null,
      currentStep: 1
    };

    // DOM elements cache
    let elements = {};

    // Steps
    const STEPS = {
      EMAIL: 1,
      EMAIL_SENT: 2,
      PASSWORD_RESET: 3,
      SUCCESS: 4,
      LOADING: 'loading',
      INVALID: 'invalid'
    };

    // Initialize application
    function initApp() {
      console.log('🔧 Initializing app...');
      
      try {
        // Cache DOM elements
        elements = {
          // Steps
          emailStep: document.getElementById('emailStep'),
          emailSentStep: document.getElementById('emailSentStep'),
          passwordResetStep: document.getElementById('passwordResetStep'),
          successStep: document.getElementById('successStep'),
          loadingStep: document.getElementById('loadingStep'),
          invalidLinkStep: document.getElementById('invalidLinkStep'),
          
          // Step indicator
          stepIndicator: document.getElementById('stepIndicator'),
          step1: document.getElementById('step1'),
          step2: document.getElementById('step2'),
          step3: document.getElementById('step3'),
          
          // Form elements
          email: document.getElementById('email'),
          newPassword: document.getElementById('newPassword'),
          confirmPassword: document.getElementById('confirmPassword'),
          
          // Buttons
          sendResetBtn: document.getElementById('sendResetBtn'),
          resendBtn: document.getElementById('resendBtn'),
          useNewEmailBtn: document.getElementById('useNewEmailBtn'),
          resetPasswordBtn: document.getElementById('resetPasswordBtn'),
          requestNewLinkBtn: document.getElementById('requestNewLinkBtn'),
          
          // Messages and displays
          emailErrorMessage: document.getElementById('emailErrorMessage'),
          passwordErrorMessage: document.getElementById('passwordErrorMessage'),
          sentEmailDisplay: document.getElementById('sentEmailDisplay'),
          resetEmailDisplay: document.getElementById('resetEmailDisplay'),
          countdown: document.getElementById('countdown'),
          loadingMessage: document.getElementById('loadingMessage'),
          
          // Password requirements
          requirements: {
            length: document.getElementById('length'),
            uppercase: document.getElementById('uppercase'),
            lowercase: document.getElementById('lowercase'),
            number: document.getElementById('number'),
            special: document.getElementById('special')
          }
        };

        // Verify elements exist
        const missingElements = Object.keys(elements).filter(key => 
          key !== 'requirements' && !elements[key]
        );
        
        if (missingElements.length > 0) {
          throw new Error(`Missing elements: ${missingElements.join(', ')}`);
        }

        // Setup event listeners
        setupEventListeners();

        // Check if we're coming from an email link
        checkForActionCode();

        console.log('✅ App initialized successfully');
      } catch (error) {
        console.error('❌ App initialization failed:', error);
        showEmailError('Failed to initialize application. Please refresh the page.');
      }
    }

    function setupEventListeners() {
      console.log('🔗 Setting up event listeners...');
      
      // Email step
      elements.sendResetBtn.addEventListener('click', handleSendReset);
      elements.email.addEventListener('input', validateEmailInput);
      elements.email.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !elements.sendResetBtn.disabled) {
          handleSendReset();
        }
      });
      
      // Email sent step
      elements.resendBtn.addEventListener('click', handleResendReset);
      elements.useNewEmailBtn.addEventListener('click', goToEmailStep);
      
      // Password reset step
      elements.newPassword.addEventListener('input', validatePassword);
      elements.confirmPassword.addEventListener('input', validatePasswordMatch);
      elements.resetPasswordBtn.addEventListener('click', handlePasswordReset);
      elements.confirmPassword.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !elements.resetPasswordBtn.disabled) {
          handlePasswordReset();
        }
      });
      
      // Invalid link step
      elements.requestNewLinkBtn.addEventListener('click', goToEmailStep);
    }

    function checkForActionCode() {
      console.log('🔍 Checking for action code...');
      
      const urlParams = new URLSearchParams(window.location.search);
      appState.actionCode = urlParams.get('oobCode');

      if (appState.actionCode) {
        console.log('📧 Action code found, verifying...');
        verifyActionCode();
      } else {
        console.log('📝 No action code, showing email step');
        showStep(STEPS.EMAIL);
      }
    }

    async function verifyActionCode() {
      showStep(STEPS.LOADING);
      elements.loadingMessage.textContent = 'Verifying reset link...';

      try {
        console.log('🔐 Verifying action code with Firebase...');
        
        const email = await auth.verifyPasswordResetCode(appState.actionCode);
        
        console.log('✅ Action code verified for:', email);
        
        appState.currentEmail = email;
        elements.resetEmailDisplay.textContent = email;
        
        showStep(STEPS.PASSWORD_RESET);
        setTimeout(() => elements.newPassword.focus(), 100);
        
      } catch (error) {
        console.error('❌ Error verifying action code:', error);
        showStep(STEPS.INVALID);
      }
    }

    async function handleSendReset() {
      if (appState.isProcessing) return;
      
      const email = elements.email.value.trim();
      console.log('📧 Attempting to send reset email to:', email);
      
      if (!validateEmail(email)) {
        showEmailError('Please enter a valid email address');
        return;
      }

      appState.isProcessing = true;
      setButtonLoading(elements.sendResetBtn, 'Checking account...');
      hideEmailError();

      try {
        // Step 1: Check if email exists in our backend
        console.log('🔍 Checking if email exists in database...');
        
        const checkResponse = await fetch('/api/forgot-password/check-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: email })
        });

        const checkData = await checkResponse.json();
        console.log('📊 Email check response:', checkData);

        if (!checkResponse.ok) {
          throw new Error(checkData.detail || 'Error checking email');
        }

        if (!checkData.exists) {
          showEmailError('No account found with this email address');
          return;
        }

        // Step 2: Send password reset email using Firebase Auth
        console.log('📨 Sending Firebase reset email...');
        
        setButtonLoading(elements.sendResetBtn, 'Sending email...');
        
        // Configure action code settings
        const actionCodeSettings = {
          url: `${window.location.origin}/forgot-password`,
          handleCodeInApp: false
        };
        
        await auth.sendPasswordResetEmail(email, actionCodeSettings);

        console.log('✅ Reset email sent successfully');
        
        // Store email and show success screen
        appState.currentEmail = email;
        elements.sentEmailDisplay.textContent = email;
        
        // Switch to email sent step
        showStep(STEPS.EMAIL_SENT);
        
        // Start resend countdown
        startResendCountdown();
        
      } catch (error) {
        console.error('❌ Send reset error:', error);
        handleFirebaseError(error, 'email');
      } finally {
        appState.isProcessing = false;
        setButtonLoading(elements.sendResetBtn, 'Send Reset Link');
      }
    }

    async function handleResendReset() {
      if (appState.isProcessing || appState.resendCountdown > 0) return;

      console.log('🔄 Resending reset email...');
      
      appState.isProcessing = true;
      setButtonLoading(elements.resendBtn, 'Sending...');

      try {
        const actionCodeSettings = {
          url: `${window.location.origin}/forgot-password`,
          handleCodeInApp: false
        };
        
        await auth.sendPasswordResetEmail(appState.currentEmail, actionCodeSettings);

        console.log('✅ Reset email resent successfully');
        showTemporarySuccess('Reset link sent again! Check your email.');
        startResendCountdown();
        
      } catch (error) {
        console.error('❌ Resend error:', error);
        handleFirebaseError(error, 'email');
      } finally {
        appState.isProcessing = false;
        setButtonLoading(elements.resendBtn, 'Resend Reset Link');
      }
    }

    async function handlePasswordReset() {
      if (appState.isProcessing) return;

      const newPassword = elements.newPassword.value;
      const confirmPassword = elements.confirmPassword.value;

      console.log('🔒 Attempting password reset...');

      if (!validatePasswordRequirements(newPassword)) {
        showPasswordError('Password does not meet all requirements');
        return;
      }

      if (newPassword !== confirmPassword) {
        showPasswordError('Passwords do not match');
        return;
      }

      appState.isProcessing = true;
      setButtonLoading(elements.resetPasswordBtn, 'Updating...');
      hidePasswordError();

      try {
        console.log('🔐 Confirming password reset with Firebase...');
        
        // Step 1: Reset password in Firebase Auth
        await auth.confirmPasswordReset(appState.actionCode, newPassword);
        
        console.log('✅ Firebase password reset successful');
        
        // Step 2: Update password in Firestore database
        console.log('🔄 Updating password in Firestore...');
        
        try {
          const updateResponse = await fetch('/api/forgot-password/update-database', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              email: appState.currentEmail,
              newPassword: newPassword
            })
          });

          if (!updateResponse.ok) {
            const errorData = await updateResponse.json();
            console.warn('⚠️ Database update failed:', errorData.detail);
            // Continue anyway since Firebase Auth was successful
          } else {
            console.log('✅ Database password updated successfully');
          }
        } catch (dbError) {
          console.warn('⚠️ Database update error:', dbError);
          // Continue anyway since Firebase Auth was successful
        }
        
        // Show success state
        showStep(STEPS.SUCCESS);
        
        // Clear URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);
        
      } catch (error) {
        console.error('❌ Error resetting password:', error);
        handleFirebaseError(error, 'password');
      } finally {
        appState.isProcessing = false;
        setButtonLoading(elements.resetPasswordBtn, 'Update Password');
      }
    }

    function validateEmailInput() {
      const email = elements.email.value.trim();
      elements.sendResetBtn.disabled = !validateEmail(email);
    }

    function validatePassword() {
      const password = elements.newPassword.value;
      const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /\d/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
      };

      // Update visual feedback
      Object.keys(requirements).forEach(req => {
        const element = elements.requirements[req];
        element.classList.remove('valid', 'invalid', 'neutral');
        
        if (password.length === 0) {
          element.classList.add('neutral');
        } else if (requirements[req]) {
          element.classList.add('valid');
        } else {
          element.classList.add('invalid');
        }
      });

      validatePasswordMatch();
      
      return Object.values(requirements).every(req => req);
    }

    function validatePasswordMatch() {
      const newPassword = elements.newPassword.value;
      const confirmPassword = elements.confirmPassword.value;
      
      const isValid = validatePasswordRequirements(newPassword);
      const passwordsMatch = newPassword === confirmPassword && newPassword.length > 0;
      
      elements.resetPasswordBtn.disabled = !(isValid && passwordsMatch);
    }

    function validatePasswordRequirements(password) {
      return password.length >= 8 &&
             /[A-Z]/.test(password) &&
             /[a-z]/.test(password) &&
             /\d/.test(password) &&
             /[!@#$%^&*(),.?":{}|<>]/.test(password);
    }

    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function showStep(step) {
      console.log('👀 Showing step:', step);
      
      // Hide all steps
      [elements.emailStep, elements.emailSentStep, elements.passwordResetStep, 
       elements.successStep, elements.loadingStep, elements.invalidLinkStep]
        .forEach(el => el && el.classList.add('hidden'));

      // Update step indicator
      updateStepIndicator(step);

      // Show requested step
      switch(step) {
        case STEPS.EMAIL:
          elements.emailStep.classList.remove('hidden');
          setTimeout(() => elements.email.focus(), 100);
          appState.currentStep = 1;
          break;
        case STEPS.EMAIL_SENT:
          elements.emailSentStep.classList.remove('hidden');
          appState.currentStep = 2;
          break;
        case STEPS.PASSWORD_RESET:
          elements.passwordResetStep.classList.remove('hidden');
          appState.currentStep = 3;
          break;
        case STEPS.SUCCESS:
          elements.successStep.classList.remove('hidden');
          elements.stepIndicator.classList.add('hidden');
          break;
        case STEPS.LOADING:
          elements.loadingStep.classList.remove('hidden');
          elements.stepIndicator.classList.add('hidden');
          break;
        case STEPS.INVALID:
          elements.invalidLinkStep.classList.remove('hidden');
          elements.stepIndicator.classList.add('hidden');
          break;
      }
    }

    function updateStepIndicator(currentStep) {
      const steps = [elements.step1, elements.step2, elements.step3];
      
      steps.forEach((step, index) => {
        step.classList.remove('active', 'completed');
        
        if (index + 1 < currentStep || (currentStep === STEPS.SUCCESS && index < 3)) {
          step.classList.add('completed');
        } else if (index + 1 === currentStep) {
          step.classList.add('active');
        }
      });
    }

    function goToEmailStep() {
      console.log('🔄 Going back to email step');
      
      // Clear form
      elements.email.value = '';
      appState.currentEmail = '';
      appState.actionCode = null;
      
      // Clear URL parameters
      window.history.replaceState({}, document.title, window.location.pathname);
      
      // Show email step
      showStep(STEPS.EMAIL);
      
      // Stop countdown if running
      if (appState.countdownInterval) {
        clearInterval(appState.countdownInterval);
        appState.countdownInterval = null;
      }
    }

    function startResendCountdown() {
      console.log('⏰ Starting resend countdown');
      
      appState.resendCountdown = 60;
      elements.resendBtn.disabled = true;
      elements.countdown.classList.remove('hidden');
      
      appState.countdownInterval = setInterval(() => {
        appState.resendCountdown--;
        
        if (appState.resendCountdown > 0) {
          elements.countdown.textContent = `You can resend in ${appState.resendCountdown} seconds`;
        } else {
          clearInterval(appState.countdownInterval);
          elements.resendBtn.disabled = false;
          elements.countdown.classList.add('hidden');
          console.log('⏰ Countdown finished');
        }
      }, 1000);
    }

    function showEmailError(message) {
      console.log('❌ Email error:', message);
      elements.emailErrorMessage.textContent = message;
      elements.emailErrorMessage.classList.remove('hidden');
    }

    function hideEmailError() {
      elements.emailErrorMessage.classList.add('hidden');
    }

    function showPasswordError(message) {
      console.log('❌ Password error:', message);
      elements.passwordErrorMessage.textContent = message;
      elements.passwordErrorMessage.classList.remove('hidden');
    }

    function hidePasswordError() {
      elements.passwordErrorMessage.classList.add('hidden');
    }

    function showTemporarySuccess(message) {
      console.log('✅ Temporary success:', message);
      
      const successDiv = document.createElement('div');
      successDiv.className = 'message-box success';
      successDiv.textContent = message;
      
      elements.emailSentStep.insertBefore(successDiv, elements.emailSentStep.querySelector('.resend-section'));
      
      setTimeout(() => {
        if (successDiv.parentNode) {
          successDiv.parentNode.removeChild(successDiv);
        }
      }, 5000);
    }

    function setButtonLoading(button, text) {
      if (text.includes('...') || text.includes('Sending') || text.includes('Checking') || text.includes('Updating')) {
        button.disabled = true;
        button.innerHTML = `<span class="loading"></span>${text}`;
      } else {
        button.innerHTML = text;
      }
    }

    function handleFirebaseError(error, context) {
      console.error(`❌ Firebase error in ${context}:`, error);
      
      const errorMessages = {
        'auth/user-not-found': 'No account found with this email address.',
        'auth/invalid-email': 'Invalid email address format.',
        'auth/too-many-requests': 'Too many reset attempts. Please try again later.',
        'auth/network-request-failed': 'Network error. Please check your connection and try again.',
        'auth/internal-error': 'Internal error. Please try again later.',
        'auth/expired-action-code': 'This reset link has expired. Please request a new one.',
        'auth/invalid-action-code': 'This reset link is invalid. Please request a new one.',
        'auth/user-disabled': 'This user account has been disabled.',
        'auth/weak-password': 'Password is too weak. Please choose a stronger password.',
        'auth/unauthorized-domain': 'This domain is not authorized for password reset. Please contact support.',
        'auth/invalid-continue-uri': 'Invalid reset URL configuration. Please contact support.',
        'auth/quota-exceeded': 'Email service temporarily unavailable. Please try again later.'
      };
      
      const message = errorMessages[error.code] || error.message || 'An error occurred. Please try again.';
      
      if (error.code === 'auth/expired-action-code' || error.code === 'auth/invalid-action-code') {
        showStep(STEPS.INVALID);
      } else if (context === 'email') {
        showEmailError(message);
      } else if (context === 'password') {
        showPasswordError(message);
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (appState.countdownInterval) {
        clearInterval(appState.countdownInterval);
      }
    });

    console.log('📦 Password Reset script loaded successfully');
  </script>
</body>
</html>